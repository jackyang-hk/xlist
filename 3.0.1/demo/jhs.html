<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="yes" name="apple-touch-fullscreen"/>
<meta content="telephone=no,email=no" name="format-detection"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"/>
    <title>Xlist的demo</title>
    <script src="http://g.tbcdn.cn/kissy/k/1.4.2/seed-min.js" charset="utf-8"></script>
    <link rel="stylesheet" href="http://g.tbcdn.cn/kissy/k/1.3.0/css/dpl/base-min.css">
<link rel="stylesheet" type="text/css" href="http://g.tbcdn.cn/ju/??h5-compo/1.0.0/compo.css,wap-2014/1.2.3/app.css">
    <style type="text/css">
    body{
        margin:0;
        position: absolute;
        top:0;
        bottom: 0;
        height: 100%;
        width: 100%;
    }
    .container{
        height: 100%;
        width: 100%;
        position: absolute;
        overflow-y:hidden;
        margin-top: 45px;
    }
    .item-container{
        position: absolute;
        height: 100%;
        width: 100%;
    }
    .item{
        position:absolute;
        width:100%;
        height: 107px;
    }
    .item-list ul li{
        width: 100%;
    }
    .item-list ul li .item-pic{
        -webkit-box-shadow:none;
    }
     .ks-xlist-plugin-pullup-container{
        text-align: center;
    }
    .ks-xscroll-plugin-pulldown-container{
        text-align: center;
    }
     .ks-xlist-content{
        width: 100%;
    }
    </style>
</head>
<body>
<section id="J_Nav" class="header" style="position:absolute;z-index:100;width:100%;">
<div class="head">
    <div class="head-in" id="J_headNav">
        <div class="logo">
            <a href="#!/today">
                <s></s>
            </a>
        </div>
        <div class="naver">
            <ul>
                <li class="today on">
                    <a href="#!/today">今日</a>
                </li>
                <li class="brand">
                    <a href="#!/brand">品牌</a>
                </li>
                <li class="life">
                    <a href="#!/life">生活</a>
                </li>
            </ul>
        </div>
        <div class="hd-menu">
            <a class="btn-hd-menu"></a>
        </div>
    </div>
</div>
</section>



<div class="container item-list"  id="J_List">
    <div class="ks-xlist-container" >
    <ul class="ks-xlist-content" >
        <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
                <li class="ks-xlist-row"></li>
    </ul>
    </div>
</div>
<script type="tpl" id="J_Tpl">
<li>
<a target="_top" href="http://a.m.taobao.com/i37319860308.htm?tg_key=jhs&amp;v=0&amp;ttid=jhs_wap">
<div class="item-pic">
    <s>
    </s>
    <img class="J_IMG" width="100" height="80" data-src="{{baseinfo.picUrl}}_240x240Q90.jpg">
</div>
<div class="item-info">
    <h3 class="good-name">
        {{name.shortName}}
    </h3>
    <div class="pirce">
        <b class="promote-price">
            ￥{{price.actPrice}}
        </b>
    </div>
    <div class="buy-now">
        <span class="discount">
            {{price.discount}}折
        </span>
        <span class="cost-price">
            ￥
            <del>
                {{price.origPrice}}
            </del>
        </span>
        <span class="buy-count">
            12457人已购买
        </span>
    </div>
</div>
</a>
</li>
</script>
<script>
(function(S){
  KISSY.config({
        packages:[
            {
                name:"kg",
                 path:KISSY.Config.debug ? "http://g.assets.daily.taobao.net/kg/":"http://g.tbcdn.cn/kg/",
                ignorePackageNameInUri:true
            }
        ]
    });
S.use('node,ajax,kg/xlist/3.0.1/,kg/xscroll/1.1.5/plugin/scrollbar,kg/xscroll/1.1.5/plugin/pulldown,xtemplate', function(S,Node,Ajax, XList,ScrollBar,PullDown,XTemplate) {
    var $ = S.all,xlist;
    //记录每一页的数据
     var pageCache ={};
    var page = 1;
    var totalPage ;
    var pageSize = 96;

    function format(data){
        var fdata = [];
        for(var i in data){
            fdata.push({data:data[i]})
        }
        return fdata;
    }


    //获取每一页的数据
    function getData(){
        //如果存在就不加载
        if(page && pageCache[page]) return;
        //标记已经加载当前页
        pageCache[page] = 1;
        //创建数据集
        var ds = new XList.DataSet();

         S.io({
                url:"http://ju.taobao.com/json/tg/ajaxGetItemsV2.json",
                dataType:"jsonp",
                data:{
                    page: page,
                    type: 0
                },
                success:function(e){
                    if(e.itemList && e.itemList.length){
                        totalPage = e.totalPage;
                        var data = format(e.itemList);
                        ds.appendData(data);
                        xlist.appendDataSet(ds);
                        xlist.render();
                        showImg();
                        if(page < totalPage){
                            page ++;
                        }
                        
                    }
                    
                }
            })
    }
    var timeout;
    //图片懒加载
     function showImg(){
        clearTimeout(timeout)
        timeout = setTimeout(function(){
            $(".J_IMG",$("#J_List")).each(function(){
                $(this).attr("src",$(this).attr("data-src"))
            })
         },200)
       
    }

    $("#J_List").height($("body").height()-45);

    //实例化
    xlist = new XList({
        renderTo: "#J_List",
        renderHook:function(el,data){
                el.innerHTML = new XTemplate($("#J_Tpl").html()).render(data.data);
        },
       infiniteElements:"#J_List .ks-xlist-row",
        itemHeight: 107
    })
    //滚动条
    xlist.plug(new ScrollBar())
    //下拉刷新
    xlist.plug(new PullDown())

      xlist.on("scroll",function(e){
            if(e.offset.y<0 && Math.abs(e.offset.y)>=xlist.get("containerHeight")-xlist.get("height") - 40){
                getData();
            }
        })

    xlist.on("scrollEnd",function(e){
        if (xlist.isScrollingY) return;
        showImg();
    })
    //获取首页数据
    getData();

    window.xlist = xlist;

})
})(KISSY)
</script>
</body>
</html>
