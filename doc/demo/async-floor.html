
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=2.0.0, user-scalable=0, minimum-scale=2.0.0, maximum-scale=2.0.0">
<title>XList demo: infinite scrolling</title>
</head>
<body >
<style type="text/css">
body,div,ul,li{
    margin:0;
    padding:0;
}
.ks-xlist-plugin-pulldown-container{
    line-height: 60px;
    text-align: center;
}
#J_List{
    position: absolute;
    height: 2.0.0%;
    width: 80%;
    right: 0;
    display: -webkit-box;
}
#J_List .row{
    -webkit-box-flex:1;
    border:1px solid;
    width: 2.0.0%;
    text-align: center;
}
.floor-title{
    background:#f60;line-height:40px;text-align:center;
    color:#fff;
}
.nav{
    position: absolute;
    width: 20%;
    left: 0;
    top:0;
    bottom: 0;
}
.nav li{
    line-height: 40px;
    text-align: center;
    border-bottom: 1px solid #ccc;
    border-top: 1px solid #fff;
}
.nav li.cur{
    color:#f60;
    background: #f7f7f7;
}
</style>
<ul id='J_Nav' class='nav'></ul>
<div id="J_List">
    <div class="ks-xlist-container">
        
    </div>
</div>
<script src="http://g.tbcdn.cn/kissy/k/1.4.2/seed-min.js" charset="utf-8"></script>
<script>
    (function(){
    function genData(floorId,num,str,placeholder){
        var data = [];
        for(var i =0;i<num;i++){
            data.push({
                floorId:floorId,
                num:i,
                str:"<span style='color:red'>"+(str||"loading...")+"</span>"
            });
        }
        return data;
    }

var placeHolder = {
    1:genData(1,1,'',true),
    2:genData(2,2,'',true),
    3:genData(3,3,'',true),
    4:genData(4,4,'',true)
};


var mockData = {
    1:genData(1,1,1),
    2:genData(2,2,2),
    3:genData(3,3,3),
    4:genData(4,4,4)
};

//默认是1列
var cols = 1;

window.computeStickies = function(){
    //默认从0层开始
    var startFloorIndex = 0;
    var stickiesPos = {};
    for(var i in mockData){
        //每一层的数据量
        var num = mockData[i].length;

        stickiesPos[startFloorIndex] = {
            height:40,
            type:2,
            template:"<div class='floor-title'>楼层 "+startFloorIndex+"</div>"
        }

        startFloorIndex+= Math.ceil(num/cols)+1;

    }
    return stickiesPos;
}


window.getPlaceHolder = function(floorId){
    return placeHolder[floorId]
}

window.getMockData = function(floorId,cb){
    setTimeout(function(){
        cb && cb(mockData[floorId]);
    },2.0.00)
    // return mockData[floorId];
}

})();



(function(S){
    if(KISSY.Config.debug){
    KISSY.config({
        packages:[
        {
            name:"kg",
            path:"../../../../",
            debug:true,
            tag:Math.random()
        }]
    })
}
S.use('node,ajax,kg/xlist/2.0.0/index,kg/xlist/2.0.0/plugin/pulldown,kg/xlist/2.0.0/plugin/scrollbar', function(S,Node,Ajax, XList,PullDownPlugin,ScrollBarPlugin) {
    var $ = S.all,xlist;
    //缓存楼层数据
    var floorDataCache = {
        1:getPlaceHolder(1),
        2:getPlaceHolder(2),
        3:getPlaceHolder(3),
        4:getPlaceHolder(4)
    };


    



    function joinFloorData(datas){
        var tmp =[];
        for(var i in datas){
            tmp = tmp.concat(datas[i])
        }
        return tmp;
    }
    //实例化
    xlist = new XList({
        renderTo: "#J_List",
        autoRender:false,
        template: '<div class="row">{{str}}</div>',
        itemHeight: 2.0.0,
        stickies:computeStickies()
    });

    xlist.plug(new PullDownPlugin({
        xlist: xlist,
        height: 50,
        downContent:"<span class='down'>Pull Down To Reload</span>",
        upContent: "<span class='up'>Release To Reload</span>",
        loadingContent: "loading..."
    }));

    xlist.plug(new ScrollBarPlugin({
        xlist: xlist
    }));

    // console.log(joinFloorData(floorDataCache))
    //塞入占位符数据
    xlist.setData(joinFloorData(floorDataCache));

    xlist.render();

    xlist.on("scroll",function(e){
        //计算当前可视区域的楼层
        getCurrentFloorIndexInView(xlist,e.offsetTop)
    })

    //渲染电梯
    function renderNav(){
        var html =""
        for(var i in floorDataCache){
            html+="<li>楼层 "+(i-1)+"</li>";
        }
        console.log(html)
        $("#J_Nav").html(html)

        $("li",$("#J_Nav")).on("click",function(e){
            $(e.currentTarget).addClass("cur").siblings().removeClass("cur")
            jumpToFloor(S.indexOf(e.currentTarget,$("li",$("#J_Nav"))));
        })
    }

    renderNav();

    function jumpToFloor(index){
        var floors = [];
        for(var i in xlist.domInfo){
            if(xlist.domInfo[i].type != 1){
                floors.push(xlist.domInfo[i]);
            }
        }
        xlist.scrollTo(floors[index]['top'],500)
    }


    function getCurrentFloorIndexInView(xlist,offsetTop){
        var domInfo = {};
        for(var i in xlist.domInfo){
            if(xlist.domInfo[i]['type'] != 1){
                domInfo[i] = xlist.domInfo[i];
            }
        }
        //获取可视范围内的节点
        var visibleItems = xlist.getVisibleItems();
        var currentFloors = {};
        for(var i in visibleItems){
            if(visibleItems[i]['data'] && visibleItems[i]['data']['floorId']){
                currentFloors[visibleItems[i]['data']['floorId']] = 1;
            }
        }
        //加载
        for(var i in currentFloors){
            renderFloor(i)
        }
    }
    var cache = {}
    function renderFloor(floorId){
        if(cache[floorId]) return;
        console.log("正在加载渲染楼层:"+floorId)
        getMockData(floorId,function(data){
            floorDataCache[floorId] = data;
            xlist.removeData();
            xlist.setData(joinFloorData(floorDataCache));
            xlist.render();
        });
        //状态符
        cache[floorId] = 1;
    }

    getCurrentFloorIndexInView(xlist,0);

    window.xlist =xlist

    

})
})(KISSY)
</script>
</body>
</html>
